<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archetype & Validation - Ehrtslib</title>
    <link rel="stylesheet" href="../docs/demo/styles.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }

        h2 {
            color: #764ba2;
            margin-top: 40px;
            margin-bottom: 20px;
        }

        h3 {
            color: #475569;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: #f8fafc;
            border-left: 4px solid #2563eb;
            padding: 20px;
            border-radius: 5px;
        }

        .feature-card h3 {
            margin-top: 0;
            color: #2563eb;
        }

        .feature-list {
            list-style: none;
            padding-left: 0;
        }

        .feature-list li::before {
            content: "‚úì ";
            color: #10b981;
            font-weight: bold;
            margin-right: 8px;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 14px;
        }

        code {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
        }

        .info-box {
            background: #dbeafe;
            border-left: 4px solid #2563eb;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .warning-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .success-box {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .nav-links {
            margin: 30px 0;
            padding: 20px;
            background: #f1f5f9;
            border-radius: 5px;
        }

        .nav-links a {
            color: #2563eb;
            text-decoration: none;
            margin-right: 20px;
        }

        .nav-links a:hover {
            text-decoration: underline;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            border: 1px solid #e2e8f0;
            padding: 12px;
            text-align: left;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #2563eb;
            text-decoration: none;
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="../index.html" class="back-link">‚Üê Back to Documentation</a>

        <h1>üèóÔ∏è Archetype & Validation Framework</h1>

        <p class="intro">
            Comprehensive support for openEHR Archetype Model (AM) layer including ADL2 parsing,
            template validation, and code generation. Implements grammar-assisted approach for
            correctness and completeness.
        </p>

        <div class="nav-links">
            <strong>Quick Navigation:</strong>
            <a href="#parsing">ADL2 Parsing</a>
            <a href="#validation">Validation</a>
            <a href="#generation">Code Generation</a>
            <a href="#examples">Examples</a>
        </div>

        <h2 id="parsing">üìÑ ADL2 Parsing</h2>

        <p>
            Parse ADL2 (Archetype Definition Language) files into AOM (Archetype Object Model).
            Based on official ANTLR grammars from openEHR/archie for specification compliance.
        </p>

        <div class="feature-grid">
            <div class="feature-card">
                <h3>ADL2 Tokenizer</h3>
                <ul class="feature-list">
                    <li>All ADL2 keywords</li>
                    <li>Node codes (id1, at0000)</li>
                    <li>Version numbers</li>
                    <li>Archetype IDs</li>
                    <li>Line/column tracking</li>
                </ul>
            </div>
            <div class="feature-card">
                <h3>ODIN Parser</h3>
                <ul class="feature-list">
                    <li>Attribute-value pairs</li>
                    <li>Nested objects</li>
                    <li>Keyed objects/lists</li>
                    <li>Primitive values & lists</li>
                    <li>Keywords as identifiers</li>
                </ul>
            </div>
            <div class="feature-card">
                <h3>cADL Parser</h3>
                <ul class="feature-list">
                    <li>Complex objects</li>
                    <li>Attributes & constraints</li>
                    <li>Occurrences</li>
                    <li>Nested structures</li>
                    <li>Multiple attributes</li>
                </ul>
            </div>
        </div>

        <h3>Usage Example</h3>
        <pre><code>import { ADL2Tokenizer, ADL2Parser } from "./enhanced/parser/mod.ts";

// Parse ADL2 file
const tokenizer = new ADL2Tokenizer(adl2Text);
const tokens = tokenizer.tokenize();

const parser = new ADL2Parser(tokens);
const { archetype, warnings } = parser.parse();

console.log("Archetype ID:", archetype.archetype_id?.value);
console.log("Definition:", archetype.definition);</code></pre>

        <h2 id="validation">‚úÖ Validation Framework</h2>

        <p>
            Comprehensive validation of RM instances against operational templates and archetypes.
            Non-intrusive external validator design that doesn't modify RM classes.
        </p>

        <div class="success-box">
            <strong>‚úì Complete Validation Coverage</strong><br>
            50/50 tests passing across all validators with detailed error reporting and configurable options.
        </div>

        <h3>Validators</h3>

        <table>
            <thead>
                <tr>
                    <th>Validator</th>
                    <th>Purpose</th>
                    <th>Examples</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Occurrence</strong></td>
                    <td>Min/max occurrence constraints</td>
                    <td>0..1, 1..*, 2..5</td>
                </tr>
                <tr>
                    <td><strong>Cardinality</strong></td>
                    <td>Collection size constraints</td>
                    <td>Arrays, lists</td>
                </tr>
                <tr>
                    <td><strong>Primitive</strong></td>
                    <td>String patterns, integer/real ranges, boolean constraints</td>
                    <td>Regex patterns, value lists</td>
                </tr>
                <tr>
                    <td><strong>Terminology</strong></td>
                    <td>DV_CODED_TEXT structure validation</td>
                    <td>defining_code, terminology_id</td>
                </tr>
                <tr>
                    <td><strong>UCUM Units</strong></td>
                    <td>Unit validation in DV_QUANTITY</td>
                    <td>mg/dL, Cel, [degF]</td>
                </tr>
                <tr>
                    <td><strong>Intervals</strong></td>
                    <td>DV_INTERVAL bounds and ordering</td>
                    <td>lower ‚â§ upper, unbounded flags</td>
                </tr>
                <tr>
                    <td><strong>RM Specification</strong></td>
                    <td>RM-mandated code lists</td>
                    <td>COMPOSITION.category: 431, 433</td>
                </tr>
            </tbody>
        </table>

        <h3>Configuration</h3>
        <pre><code>import { TemplateValidator } from "./enhanced/validation/template_validator.ts";

const validator = new TemplateValidator({
  failFast: false,                    // Stop on first error
  maxDepth: 100,                      // Max validation depth
  validateUnits: true,                // UCUM unit validation
  validateTerminology: true,          // Terminology validation
  validateIntervals: true,            // DV_INTERVAL validation
  validateRMSpecification: true,      // RM spec constraints
  useTypeRegistry: true,              // Type resolution
});

// Initialize async dependencies (UCUM service)
await validator.initialize();

// Validate
const result = validator.validate(rmInstance, template);

if (!result.valid) {
  result.errors.forEach(err => {
    console.log(`${err.path}: ${err.message} [${err.constraintType}]`);
  });
}</code></pre>

        <div class="info-box">
            <strong>‚ÑπÔ∏è RM Specification Constraints</strong><br>
            The RM Specification Validator enforces constraints defined in the openEHR Reference Model
            specification itself, such as COMPOSITION.category must be 431 (persistent) or 433 (event).
            This is separate from archetype/template constraints.
        </div>

        <h3>Error Reporting</h3>
        <pre><code>// Example validation errors with constraint types
[
  {
    path: "/category",
    message: "Code '999' not allowed by RM specification. Allowed: 431|persistent|, 433|event|",
    severity: "error",
    constraintType: "rm_specification"
  },
  {
    path: "/data/interval",
    message: "Interval lower bound (100) exceeds upper bound (50)",
    severity: "error",
    constraintType: "interval"
  },
  {
    path: "/value",
    message: "String 'test' does not match pattern: ^[A-Z]{3}$",
    severity: "error",
    constraintType: "string_pattern"
  }
]</code></pre>

        <h2 id="generation">üîß Code Generation</h2>

        <p>
            Generate TypeScript code, RM instances, and serialize back to ADL2 format.
        </p>

        <div class="feature-grid">
            <div class="feature-card">
                <h3>TypeScript Generator</h3>
                <ul class="feature-list">
                    <li>Natural language names from terminology</li>
                    <li>TypeScript interfaces</li>
                    <li>JSDoc with descriptions</li>
                    <li>Builder functions</li>
                    <li>Validation logic</li>
                </ul>
            </div>
            <div class="feature-card">
                <h3>RM Instance Generator</h3>
                <ul class="feature-list">
                    <li>Valid RM instances from templates</li>
                    <li>Minimal/maximal modes</li>
                    <li>Respects constraints</li>
                    <li>Configurable depth</li>
                </ul>
            </div>
            <div class="feature-card">
                <h3>ADL2 Serializer</h3>
                <ul class="feature-list">
                    <li>AOM ‚Üí ADL2 format</li>
                    <li>Round-trip support</li>
                    <li>Configurable indentation</li>
                    <li>Complete metadata</li>
                </ul>
            </div>
        </div>

        <h3>TypeScript Generation Example</h3>
        <pre><code>import { TypeScriptGenerator } from "./enhanced/generation/mod.ts";

const generator = new TypeScriptGenerator({
  language: "en",              // Use English terminology
  includeValidation: true,     // Include validation logic
  terseStyle: true,            // Compact style
});

const code = generator.generate(template);

// Generates TypeScript with natural language names:
// interface BloodPressure {
//   systolic: number;  // from terminology: "Systolic blood pressure"
//   diastolic: number; // from terminology: "Diastolic blood pressure"
// }</code></pre>

        <h2 id="examples">üìö Examples & Resources</h2>

        <div class="feature-grid">
            <div class="feature-card">
                <h3>Complete Usage Guide</h3>
                <p>
                    See <a href="../examples/archetype_template_usage.ts">archetype_template_usage.ts</a>
                    for comprehensive examples of parsing, validation, and generation.
                </p>
            </div>
            <div class="feature-card">
                <h3>Interactive Demo</h3>
                <p>
                    Try the <a href="../examples/demo-app/mockup/archetype-demo.html">Archetype & Validation Demo</a>
                    to experiment with validation and code generation.
                </p>
            </div>
            <div class="feature-card">
                <h3>Source Code</h3>
                <p>
                    Explore the implementation in
                    <a href="../enhanced/parser/">enhanced/parser/</a>,
                    <a href="../enhanced/validation/">enhanced/validation/</a>, and
                    <a href="../enhanced/generation/">enhanced/generation/</a>.
                </p>
            </div>
        </div>

        <h3>Test Coverage</h3>
        <table>
            <thead>
                <tr>
                    <th>Component</th>
                    <th>Tests</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>ADL2 Tokenizer</td>
                    <td>11/11</td>
                    <td>‚úÖ</td>
                </tr>
                <tr>
                    <td>ODIN Parser</td>
                    <td>12/12</td>
                    <td>‚úÖ</td>
                </tr>
                <tr>
                    <td>cADL Parser</td>
                    <td>7/7</td>
                    <td>‚úÖ</td>
                </tr>
                <tr>
                    <td>Basic Validator</td>
                    <td>3/3</td>
                    <td>‚úÖ</td>
                </tr>
                <tr>
                    <td>Enhanced Validator</td>
                    <td>4/4</td>
                    <td>‚úÖ</td>
                </tr>
                <tr>
                    <td>Interval & RM Validator</td>
                    <td>13/13</td>
                    <td>‚úÖ</td>
                </tr>
                <tr>
                    <td><strong>Total</strong></td>
                    <td><strong>50/50</strong></td>
                    <td><strong>‚úÖ</strong></td>
                </tr>
            </tbody>
        </table>

        <h2>Architecture</h2>

        <ul class="feature-list">
            <li><strong>Zero runtime dependencies</strong> for parsing (hand-written with grammar guidance)</li>
            <li><strong>Optional dependencies</strong> for enhancements (UCUM validation)</li>
            <li><strong>Non-intrusive validation</strong> (external validators, no RM class modification)</li>
            <li><strong>Grammar-assisted approach</strong> using official openEHR ANTLR grammars</li>
            <li><strong>Full TypeScript type safety</strong> throughout</li>
            <li><strong>Modular design</strong> with clear separation of concerns</li>
            <li><strong>Configurable features</strong> - enable/disable as needed</li>
        </ul>

        <div class="warning-box">
            <strong>‚ö†Ô∏è Note on ADL 1.4</strong><br>
            Currently supports ADL2 format. ADL 1.4 converter is planned for future enhancement.
        </div>

        <div class="nav-links">
            <strong>Related Documentation:</strong>
            <a href="getting-started.md">Getting Started</a>
            <a href="../ROADMAP.md">Roadmap</a>
            <a href="../README.md">Main README</a>
        </div>
    </div>
</body>

</html>
