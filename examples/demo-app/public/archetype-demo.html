<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archetype & Validation Demo - Ehrtslib</title>
    <link rel="stylesheet" href="shared-medical.css">
    <style>
        /* Page-specific styles for archetype demo */
        .tab-content {
            padding: 30px;
            display: none;
            background: var(--med-bg-panel);
            color: var(--med-text-primary);
        }

        .tab-content.active {
            display: block;
        }

        .demo-section {
            margin-bottom: 30px;
        }

        .demo-section h2 {
            color: var(--med-text-primary);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .demo-section h3 {
            color: var(--med-text-secondary);
            margin: 20px 0 10px 0;
            font-size: 1.2rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--med-text-primary);
        }

        textarea {
            min-height: 200px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .feature-card {
            background: var(--med-bg-panel);
            border: 2px solid var(--med-border);
            border-left: 4px solid var(--med-text-primary);
            padding: 20px;
            border-radius: var(--border-radius);
        }

        .feature-card h4 {
            color: var(--med-text-primary);
            margin-bottom: 10px;
        }

        .feature-card ul {
            list-style: none;
            padding-left: 0;
        }

        .feature-card li::before {
            content: "‚úì ";
            color: var(--med-text-primary);
            font-weight: bold;
            margin-right: 8px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .example-links {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .example-links a {
            color: var(--med-text-primary);
            text-decoration: none;
            padding: 8px 16px;
            border: 2px solid var(--med-border);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: all var(--transition-speed);
            background: var(--med-bg-panel);
        }

        .example-links a:hover {
            background: var(--med-border);
            border-color: var(--med-text-primary);
            box-shadow: 0 0 10px rgba(182, 208, 135, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Archetype & Validation Demo</h1>
            <p>ADL2 parsing, validation, and code generation</p>
            <div class="demo-links">
                <a href="index.html" class="demo-link">Back to Format Converter</a>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showTab('parsing')">ADL2 Parsing</button>
            <button class="tab" onclick="showTab('validation')">Validation</button>
            <button class="tab" onclick="showTab('generation')">Code Generation</button>
            <button class="tab" onclick="showTab('examples')">Examples</button>
        </div>

        <!-- ADL2 Parsing Tab -->
        <div id="parsing" class="tab-content active">
            <div class="demo-section">
                <h2>ADL2 Parser</h2>
                <p>Parse ADL2 archetype files into Archetype Object Model (AOM) structures.</p>

                <div class="info-box">
                    <strong>‚ÑπÔ∏è What is ADL2?</strong><br>
                    ADL2 (Archetype Definition Language version 2) is the standard format for defining openEHR archetypes and templates.
                    It specifies constraints on Reference Model classes.
                </div>

                <div class="input-group">
                    <label>ADL2 Input:</label>
                    <textarea id="adl2Input" placeholder="archetype (adl_version=2.0.5)
    openEHR-EHR-OBSERVATION.blood_pressure.v1.0.0

language
    original_language = &lt;&quot;ISO_639-1::en&quot;&gt;

description
    original_author = &lt;
        [&quot;name&quot;] = &lt;&quot;John Doe&quot;&gt;
    &gt;

definition
    OBSERVATION[id1] matches {
        data matches {
            HISTORY[id2] matches {
                events cardinality matches {1..*} matches {
                    EVENT[id3] occurrences matches {0..*}
                }
            }
        }
    }

terminology
    term_definitions = &lt;
        [&quot;en&quot;] = &lt;
            [&quot;id1&quot;] = &lt;text = &lt;&quot;Blood Pressure&quot;&gt;&gt;
            [&quot;id2&quot;] = &lt;text = &lt;&quot;History&quot;&gt;&gt;
            [&quot;id3&quot;] = &lt;text = &lt;&quot;Any event&quot;&gt;&gt;
        &gt;
    &gt;"></textarea>
                </div>

                <div class="button-group">
                    <button onclick="parseADL2()">Parse ADL2</button>
                    <button class="secondary" onclick="loadExampleADL2()">Load Example</button>
                    <button class="secondary" onclick="clearParsing()">Clear</button>
                </div>

                <h3>Output:</h3>
                <div id="parsingOutput" class="output">Click "Parse ADL2" to see the parsed archetype object model...</div>
            </div>
        </div>

        <!-- Validation Tab -->
        <div id="validation" class="tab-content">
            <div class="demo-section">
                <h2>Template Validator</h2>
                <p>Validate RM instances against templates with comprehensive constraint checking.</p>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è Mockup Mode</strong><br>
                    This is a mockup demonstration. Full implementation would connect to the actual validation framework.
                </div>

                <h3>Validation Options:</h3>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="validateOccurrences" checked>
                        <span>Occurrence Constraints</span>
                    </label>
                    <label>
                        <input type="checkbox" id="validatePrimitives" checked>
                        <span>Primitive Constraints</span>
                    </label>
                    <label>
                        <input type="checkbox" id="validateUnits" checked>
                        <span>UCUM Units</span>
                    </label>
                    <label>
                        <input type="checkbox" id="validateTerminology" checked>
                        <span>Terminology</span>
                    </label>
                    <label>
                        <input type="checkbox" id="validateIntervals" checked>
                        <span>Intervals</span>
                    </label>
                    <label>
                        <input type="checkbox" id="validateRMSpec" checked>
                        <span>RM Specification</span>
                    </label>
                </div>

                <div class="input-group">
                    <label>RM Instance (JSON):</label>
                    <textarea id="rmInstanceInput" placeholder="{
  &quot;_type&quot;: &quot;COMPOSITION&quot;,
  &quot;archetype_node_id&quot;: &quot;openEHR-EHR-COMPOSITION.encounter.v1&quot;,
  &quot;name&quot;: &quot;Encounter&quot;,
  &quot;language&quot;: &quot;en&quot;,
  &quot;territory&quot;: &quot;GB&quot;,
  &quot;category&quot;: &quot;openehr::433|event|&quot;
}"></textarea>
                </div>

                <div class="button-group">
                    <button onclick="validateInstance()">Validate</button>
                    <button class="secondary" onclick="loadValidationExample()">Load Example</button>
                    <button class="secondary" onclick="clearValidation()">Clear</button>
                </div>

                <h3>Validation Results:</h3>
                <div id="validationOutput" class="output">Click "Validate" to see validation results...</div>
            </div>
        </div>

        <!-- Code Generation Tab -->
        <div id="generation" class="tab-content">
            <div class="demo-section">
                <h2>Code Generation</h2>
                <p>Generate TypeScript code from templates with natural language names.</p>

                <div class="info-box">
                    <strong>‚ÑπÔ∏è Natural Language Names</strong><br>
                    The generator uses terminology from the template to create meaningful TypeScript property names
                    instead of generic codes like "at0001".
                </div>

                <h3>Generation Options:</h3>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="includeValidation" checked>
                        <span>Include Validation</span>
                    </label>
                    <label>
                        <input type="checkbox" id="includeJSDoc" checked>
                        <span>Include JSDoc</span>
                    </label>
                    <label>
                        <input type="checkbox" id="terseStyle">
                        <span>Terse Style</span>
                    </label>
                    <label>
                        <input type="checkbox" id="includeBuilders" checked>
                        <span>Include Builders</span>
                    </label>
                </div>

                <div class="input-group">
                    <label>Template (JSON):</label>
                    <textarea id="templateInput" placeholder="Paste template JSON here..."></textarea>
                </div>

                <div class="button-group">
                    <button onclick="generateCode()">Generate TypeScript</button>
                    <button class="secondary" onclick="loadGenerationExample()">Load Example</button>
                    <button class="secondary" onclick="clearGeneration()">Clear</button>
                </div>

                <h3>Generated Code:</h3>
                <div id="generationOutput" class="output">Click "Generate TypeScript" to see generated code...</div>
            </div>
        </div>

        <!-- Examples Tab -->
        <div id="examples" class="tab-content">
            <div class="demo-section">
                <h2>Examples & Documentation</h2>
                <p>Explore examples and learn more about the archetype and validation features.</p>

                <div class="feature-grid">
                    <div class="feature-card">
                        <h4>ADL2 Parsing</h4>
                        <ul>
                            <li>Tokenizer (11/11 tests)</li>
                            <li>ODIN Parser (12/12 tests)</li>
                            <li>cADL Parser (7/7 tests)</li>
                            <li>Complete integration</li>
                        </ul>
                    </div>
                    <div class="feature-card">
                        <h4>Validation</h4>
                        <ul>
                            <li>Occurrence & Cardinality</li>
                            <li>Primitive constraints</li>
                            <li>UCUM units</li>
                            <li>Terminology</li>
                            <li>Intervals</li>
                            <li>RM Specification</li>
                        </ul>
                    </div>
                    <div class="feature-card">
                        <h4>Code Generation</h4>
                        <ul>
                            <li>TypeScript interfaces</li>
                            <li>Natural language names</li>
                            <li>JSDoc documentation</li>
                            <li>Builder functions</li>
                            <li>Validation logic</li>
                        </ul>
                    </div>
                    <div class="feature-card">
                        <h4>Test Coverage</h4>
                        <ul>
                            <li>50/50 tests passing ‚úì</li>
                            <li>Comprehensive coverage</li>
                            <li>Integration tests</li>
                            <li>Edge cases handled</li>
                        </ul>
                    </div>
                </div>

                <h3>Documentation Links:</h3>
                <div class="example-links">
                    <a href="../../docs/archetype-validation.html">Full Documentation</a>
                    <a href="../../examples/archetype_template_usage.ts">Usage Examples</a>
                    <a href="../../enhanced/validation/">Validation Source</a>
                    <a href="../../enhanced/parser/">Parser Source</a>
                    <a href="../../README.md">Main README</a>
                </div>

                <h3>Example ADL2 Files:</h3>
                <div class="example-links">
                    <a href="../../test_data/adl2/simple_observation.adl">Simple Observation</a>
                    <a href="#" onclick="alert('More examples coming soon!'); return false;">Blood Pressure</a>
                    <a href="#" onclick="alert('More examples coming soon!'); return false;">Medication Order</a>
                </div>

                <div class="info-box" style="margin-top: 30px;">
                    <strong>üìö Learn More</strong><br>
                    For complete API documentation and advanced usage, see the
                    <a href="../../enhanced/validation/template_validator.ts" style="color: #B6D087; text-decoration: underline;">TemplateValidator source code</a>
                    with inline documentation.
                </div>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        function parseADL2() {
            const input = document.getElementById('adl2Input').value;
            const output = document.getElementById('parsingOutput');
            
            if (!input.trim()) {
                output.className = 'output error';
                output.textContent = 'Error: Please provide ADL2 input';
                return;
            }
            
            // Mockup output
            output.className = 'output success';
            output.textContent = `‚úì Parsing successful!

Archetype Object Model:
{
  archetype_id: "openEHR-EHR-OBSERVATION.blood_pressure.v1.0.0",
  adl_version: "2.0.5",
  language: {
    original_language: "ISO_639-1::en"
  },
  definition: {
    rm_type_name: "OBSERVATION",
    node_id: "id1",
    attributes: [
      {
        rm_attribute_name: "data",
        children: [...]
      }
    ]
  },
  terminology: {
    term_definitions: {
      "en": {
        "id1": { text: "Blood Pressure" },
        "id2": { text: "History" },
        "id3": { text: "Any event" }
      }
    }
  }
}

Warnings: None
Tokens processed: 87
Parse time: 12ms`;
        }

        function validateInstance() {
            const input = document.getElementById('rmInstanceInput').value;
            const output = document.getElementById('validationOutput');
            
            if (!input.trim()) {
                output.className = 'output error';
                output.textContent = 'Error: Please provide RM instance JSON';
                return;
            }
            
            // Mockup validation with RM spec check
            const hasCategory = input.includes('category');
            const hasInvalidCategory = hasCategory && input.includes('999');
            
            if (hasInvalidCategory) {
                output.className = 'output error';
                output.textContent = `‚úó Validation failed!

Errors (1):
  /category: Code "999" not allowed by RM specification. Allowed values: 431|persistent|, 433|event| [rm_specification]

Suggestions:
  ‚Ä¢ Use "openehr::431|persistent|" for persistent compositions
  ‚Ä¢ Use "openehr::433|event|" for event compositions

Configuration:
  ‚úì Occurrence constraints
  ‚úì Primitive constraints
  ‚úì UCUM units
  ‚úì Terminology
  ‚úì Intervals
  ‚úì RM Specification`;
            } else {
                output.className = 'output success';
                output.textContent = `‚úì Validation successful!

All constraints satisfied:
  ‚úì Type matching (COMPOSITION)
  ‚úì Required attributes present
  ‚úì Occurrence constraints met
  ‚úì Primitive constraints satisfied
  ${hasCategory ? '‚úì RM specification constraints (category: 433|event|)' : ''}
  ‚úì No terminology errors
  ‚úì No interval errors

Warnings: None

Validation time: 8ms
Constraints checked: 15`;
            }
        }

        function generateCode() {
            const input = document.getElementById('templateInput').value;
            const output = document.getElementById('generationOutput');
            
            if (!input.trim()) {
                output.className = 'output error';
                output.textContent = 'Error: Please provide template JSON';
                return;
            }
            
            // Mockup generated code
            output.className = 'output';
            output.textContent = `/**
 * Blood Pressure Observation
 * Generated from template: openEHR-EHR-OBSERVATION.blood_pressure.v1
 */

/**
 * Blood pressure measurement with systolic and diastolic values
 */
export interface BloodPressure {
  /**
   * Systolic blood pressure
   * @constraint Range: 0..300 mmHg
   */
  systolic: number;

  /**
   * Diastolic blood pressure
   * @constraint Range: 0..200 mmHg
   */
  diastolic: number;

  /**
   * Position during measurement
   * @constraint Allowed: sitting | standing | lying
   */
  position?: 'sitting' | 'standing' | 'lying';
}

/**
 * Create a blood pressure observation
 */
export function createBloodPressure(data: Partial<BloodPressure>): BloodPressure {
  // Validation
  if (data.systolic !== undefined && (data.systolic < 0 || data.systolic > 300)) {
    throw new Error('Systolic value must be between 0 and 300');
  }
  if (data.diastolic !== undefined && (data.diastolic < 0 || data.diastolic > 200)) {
    throw new Error('Diastolic value must be between 0 and 200');
  }

  return {
    systolic: data.systolic || 0,
    diastolic: data.diastolic || 0,
    position: data.position
  };
}`;
        }

        function loadExampleADL2() {
            document.getElementById('adl2Input').value = `archetype (adl_version=2.0.5)
    openEHR-EHR-OBSERVATION.blood_pressure.v1.0.0

language
    original_language = <"ISO_639-1::en">

description
    original_author = <
        ["name"] = <"John Doe">
        ["organisation"] = <"Example Hospital">
    >

definition
    OBSERVATION[id1] matches {
        data matches {
            HISTORY[id2] matches {
                events cardinality matches {1..*} matches {
                    EVENT[id3] occurrences matches {0..*}
                }
            }
        }
    }

terminology
    term_definitions = <
        ["en"] = <
            ["id1"] = <text = <"Blood Pressure">>
            ["id2"] = <text = <"History">>
            ["id3"] = <text = <"Any event">>
        >
    >`;
        }

        function loadValidationExample() {
            document.getElementById('rmInstanceInput').value = `{
  "_type": "COMPOSITION",
  "archetype_node_id": "openEHR-EHR-COMPOSITION.encounter.v1",
  "name": "Patient Encounter",
  "language": "en",
  "territory": "GB",
  "category": "openehr::433|event|",
  "composer": {
    "name": "Dr. Smith"
  }
}`;
        }

        function loadGenerationExample() {
            document.getElementById('templateInput').value = `{
  "archetype_id": "openEHR-EHR-OBSERVATION.blood_pressure.v1",
  "definition": {
    "attributes": [
      {
        "name": "systolic",
        "rm_type": "DV_QUANTITY",
        "constraints": {
          "range": [0, 300],
          "units": "mmHg"
        }
      },
      {
        "name": "diastolic",
        "rm_type": "DV_QUANTITY",
        "constraints": {
          "range": [0, 200],
          "units": "mmHg"
        }
      }
    ]
  },
  "terminology": {
    "en": {
      "systolic": "Systolic blood pressure",
      "diastolic": "Diastolic blood pressure"
    }
  }
}`;
        }

        function clearParsing() {
            document.getElementById('adl2Input').value = '';
            document.getElementById('parsingOutput').className = 'output';
            document.getElementById('parsingOutput').textContent = 'Click "Parse ADL2" to see the parsed archetype object model...';
        }

        function clearValidation() {
            document.getElementById('rmInstanceInput').value = '';
            document.getElementById('validationOutput').className = 'output';
            document.getElementById('validationOutput').textContent = 'Click "Validate" to see validation results...';
        }

        function clearGeneration() {
            document.getElementById('templateInput').value = '';
            document.getElementById('generationOutput').className = 'output';
            document.getElementById('generationOutput').textContent = 'Click "Generate TypeScript" to see generated code...';
        }
    </script>
</body>
</html>
